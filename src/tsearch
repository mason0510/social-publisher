#!/usr/bin/env python3
"""
tsearch - Twitter/X å®Œæ•´ç®¡ç† CLI

ç”¨æ³•:
    ts <å…³é”®è¯> [é€‰é¡¹]              # æœç´¢ï¼ˆé»˜è®¤ï¼‰
    ts post <å†…å®¹> [é€‰é¡¹]           # å‘æ¨
    ts thread <æ–‡ä»¶> [é€‰é¡¹]         # å‘ Thread
    ts reply <tweet_id> <å†…å®¹>      # å›å¤
    ts delete <tweet_id>            # åˆ é™¤
    ts --feed                       # æ¨èæµ
    ts --following                  # å…³æ³¨æµ

ç¤ºä¾‹:
    ts "AI"                         # æœç´¢
    ts post "Hello World"           # å‘æ¨
    ts post --file tweet.txt        # ä»æ–‡ä»¶å‘æ¨
    ts post --images a.jpg b.jpg    # å‘å¤šå›¾ï¼ˆæœ€å¤š4å¼ ï¼‰
    ts thread --file thread.txt     # å‘ Thread
    ts thread --file thread.txt --images img1.jpg img2.jpg  # Thread å¸¦å›¾
    ts reply 123456 "å›å¤å†…å®¹"      # å›å¤æ¨æ–‡
    ts delete 123456                # åˆ é™¤æ¨æ–‡
"""

import argparse
import json
import os
import re
import sys
import time
import subprocess

import requests
from requests_oauthlib import OAuth1

BASE_URL = "http://localhost:9531"
API_URL = f"{BASE_URL}/search"
FEED_URL = f"{BASE_URL}/feed"
HEALTH_URL = f"{BASE_URL}/health"
WARMUP_URL = f"{BASE_URL}/warmup"
BITBROWSER_API = "http://localhost:54345"
BROWSER_NAME = "us-notebookllm-02_1"


def load_env_file():
    """ä».envæ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡"""
    env_path = os.path.expanduser('~/.claude/credentials/.env')
    env_vars = {}

    try:
        with open(env_path, 'r') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    env_vars[key] = value
        return env_vars
    except Exception as e:
        print(f"âŒ è¯»å–ç¯å¢ƒå˜é‡æ–‡ä»¶å¤±è´¥: {e}", file=sys.stderr)
        sys.exit(1)


def get_twitter_auth():
    """è·å–Twitter OAuthè®¤è¯"""
    env_vars = load_env_file()

    api_key = env_vars.get('TWITTER_API_KEY')
    api_secret = env_vars.get('TWITTER_API_SECRET')
    access_token = env_vars.get('TWITTER_ACCESS_TOKEN')
    access_token_secret = env_vars.get('TWITTER_ACCESS_TOKEN_SECRET')

    if not all([api_key, api_secret, access_token, access_token_secret]):
        print("âŒ Twitter APIå‡­è¯ä¸å®Œæ•´", file=sys.stderr)
        sys.exit(1)

    return OAuth1(api_key, api_secret, access_token, access_token_secret)


def upload_images(image_paths):
    """ä¸Šä¼ å›¾ç‰‡åˆ°Twitterï¼ˆæ”¯æŒ1-4å¼ ï¼‰"""
    auth = get_twitter_auth()
    upload_url = "https://upload.twitter.com/1.1/media/upload.json"

    media_ids = []

    for image_path in image_paths:
        if not os.path.exists(image_path):
            print(f"âŒ å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: {image_path}", file=sys.stderr)
            sys.exit(1)

        print(f"ğŸ“¤ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡: {image_path}...", file=sys.stderr)

        with open(image_path, 'rb') as f:
            files = {'media': f}
            upload_resp = requests.post(upload_url, auth=auth, files=files)

        if upload_resp.status_code != 200:
            print(f"âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: {upload_resp.text}", file=sys.stderr)
            sys.exit(1)

        media_id = upload_resp.json()['media_id_string']
        media_ids.append(media_id)
        print(f"âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: {media_id}", file=sys.stderr)

    return media_ids


def post_tweet(text, image_paths=None, reply_to=None):
    """å‘å¸ƒæ¨æ–‡ï¼ˆæ”¯æŒå¤šå›¾ã€å›å¤ï¼‰

    Args:
        text: æ¨æ–‡å†…å®¹
        image_paths: å›¾ç‰‡è·¯å¾„åˆ—è¡¨ï¼ˆæœ€å¤š4å¼ ï¼‰
        reply_to: å›å¤çš„æ¨æ–‡ID

    Returns:
        dict: {'success': bool, 'tweet_id': str, 'url': str}
    """
    auth = get_twitter_auth()

    # ä¸Šä¼ å›¾ç‰‡
    media_ids = []
    if image_paths:
        if len(image_paths) > 4:
            print("âš ï¸  Twitter æœ€å¤šæ”¯æŒ 4 å¼ å›¾ç‰‡ï¼Œå°†åªä¸Šä¼ å‰ 4 å¼ ", file=sys.stderr)
            image_paths = image_paths[:4]
        media_ids = upload_images(image_paths)

    # æ„å»ºæ¨æ–‡
    url = "https://api.twitter.com/2/tweets"
    payload = {"text": text}

    if media_ids:
        payload["media"] = {"media_ids": media_ids}

    if reply_to:
        payload["reply"] = {"in_reply_to_tweet_id": str(reply_to)}

    print(f"\nğŸš€ æ­£åœ¨å‘å¸ƒæ¨æ–‡...", file=sys.stderr)
    print(f"   å­—ç¬¦æ•°: {len(text)}", file=sys.stderr)
    if len(text) > 100:
        print(f"   å†…å®¹é¢„è§ˆ: {text[:100]}...", file=sys.stderr)
    else:
        print(f"   å†…å®¹: {text}", file=sys.stderr)

    if reply_to:
        print(f"   å›å¤: {reply_to}", file=sys.stderr)
    if media_ids:
        print(f"   å›¾ç‰‡: {len(media_ids)} å¼ ", file=sys.stderr)

    try:
        response = requests.post(
            url,
            auth=auth,
            json=payload,
            headers={"Content-Type": "application/json"}
        )

        if response.status_code == 201:
            data = response.json()
            tweet_id = data['data']['id']
            tweet_url = f"https://twitter.com/user/status/{tweet_id}"

            print(f"\nâœ… æ¨æ–‡å‘å¸ƒæˆåŠŸï¼", file=sys.stderr)
            print(f"   Tweet ID: {tweet_id}", file=sys.stderr)
            print(f"   URL: {tweet_url}", file=sys.stderr)

            return {
                'success': True,
                'tweet_id': tweet_id,
                'url': tweet_url
            }
        else:
            print(f"\nâŒ å‘å¸ƒå¤±è´¥", file=sys.stderr)
            print(f"   çŠ¶æ€ç : {response.status_code}", file=sys.stderr)
            print(f"   å“åº”: {response.text}", file=sys.stderr)

            return {
                'success': False,
                'error': response.text
            }

    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}", file=sys.stderr)
        return {
            'success': False,
            'error': str(e)
        }


def post_thread(tweets, image_paths=None):
    """å‘å¸ƒ Threadï¼ˆè¿ç»­æ¨æ–‡ï¼‰

    Args:
        tweets: æ¨æ–‡å†…å®¹åˆ—è¡¨
        image_paths: å›¾ç‰‡è·¯å¾„åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œæ¯æ¡æ¨æ–‡å¹³å‡åˆ†é…ï¼‰

    Returns:
        list: [{'success': bool, 'tweet_id': str, 'url': str}, ...]
    """
    results = []
    previous_tweet_id = None

    print(f"\nğŸ§µ å¼€å§‹å‘å¸ƒ Threadï¼ˆå…± {len(tweets)} æ¡ï¼‰...\n", file=sys.stderr)

    for i, tweet_text in enumerate(tweets, 1):
        print(f"ğŸ“ [{i}/{len(tweets)}] å‘å¸ƒä¸­...", file=sys.stderr)

        # å¦‚æœæœ‰å›¾ç‰‡ï¼Œåªç»™ç¬¬ä¸€æ¡æ¨æ–‡æ·»åŠ 
        tweet_images = image_paths if (i == 1 and image_paths) else None

        result = post_tweet(
            tweet_text,
            image_paths=tweet_images,
            reply_to=previous_tweet_id
        )

        results.append(result)

        if result['success']:
            previous_tweet_id = result['tweet_id']
            print(f"âœ… [{i}/{len(tweets)}] å‘å¸ƒæˆåŠŸ\n", file=sys.stderr)

            # é¿å… API é™æµï¼Œç­‰å¾… 2 ç§’
            if i < len(tweets):
                time.sleep(2)
        else:
            print(f"âŒ [{i}/{len(tweets)}] å‘å¸ƒå¤±è´¥ï¼ŒThread ä¸­æ–­\n", file=sys.stderr)
            break

    # ç»Ÿè®¡ç»“æœ
    success_count = sum(1 for r in results if r['success'])
    print(f"\n{'='*60}", file=sys.stderr)
    print(f"ğŸ“Š Thread å‘å¸ƒå®Œæˆ", file=sys.stderr)
    print(f"âœ… æˆåŠŸ: {success_count}/{len(tweets)}", file=sys.stderr)
    print(f"âŒ å¤±è´¥: {len(tweets) - success_count}/{len(tweets)}", file=sys.stderr)

    if results and results[0]['success']:
        print(f"\nğŸ”— æŸ¥çœ‹ Thread: {results[0]['url']}", file=sys.stderr)

    return results


def parse_thread_file(file_path):
    """è§£æ Thread æ–‡ä»¶

    æ ¼å¼1ï¼ˆåˆ†éš”ç¬¦ï¼‰:
        ç¬¬ä¸€æ¡æ¨æ–‡å†…å®¹
        ---
        ç¬¬äºŒæ¡æ¨æ–‡å†…å®¹
        ---
        ç¬¬ä¸‰æ¡æ¨æ–‡å†…å®¹

    æ ¼å¼2ï¼ˆç¼–å·ï¼‰:
        1/ ç¬¬ä¸€æ¡æ¨æ–‡å†…å®¹

        2/ ç¬¬äºŒæ¡æ¨æ–‡å†…å®¹

        3/ ç¬¬ä¸‰æ¡æ¨æ–‡å†…å®¹

    Returns:
        list: æ¨æ–‡å†…å®¹åˆ—è¡¨
    """
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # å°è¯•æ ¼å¼1ï¼šåˆ†éš”ç¬¦
        if '---' in content:
            tweets = [t.strip() for t in content.split('---') if t.strip()]
            return tweets

        # å°è¯•æ ¼å¼2ï¼šç¼–å·
        pattern = r'^\d+/\s+'
        lines = content.split('\n')
        tweets = []
        current_tweet = []

        for line in lines:
            if re.match(pattern, line):
                # é‡åˆ°æ–°çš„ç¼–å·ï¼Œä¿å­˜ä¸Šä¸€æ¡
                if current_tweet:
                    tweets.append('\n'.join(current_tweet).strip())
                    current_tweet = []
                # å»æ‰ç¼–å·ï¼Œä¿ç•™å†…å®¹
                current_tweet.append(re.sub(pattern, '', line))
            else:
                if line.strip() or current_tweet:  # éç©ºè¡Œæˆ–å·²ç»åœ¨æ”¶é›†æ¨æ–‡ä¸­
                    current_tweet.append(line)

        # ä¿å­˜æœ€åä¸€æ¡
        if current_tweet:
            tweets.append('\n'.join(current_tweet).strip())

        if tweets:
            return tweets

        # å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œå½“ä½œå•æ¡æ¨æ–‡
        return [content.strip()]

    except Exception as e:
        print(f"âŒ è¯»å–æ–‡ä»¶å¤±è´¥: {e}", file=sys.stderr)
        sys.exit(1)


def delete_tweet(tweet_id):
    """åˆ é™¤æ¨æ–‡"""
    auth = get_twitter_auth()
    url = f"https://api.twitter.com/2/tweets/{tweet_id}"

    print(f"ğŸ—‘ï¸  æ­£åœ¨åˆ é™¤æ¨æ–‡ {tweet_id}...", file=sys.stderr)

    try:
        response = requests.delete(url, auth=auth)

        if response.status_code == 200:
            print(f"âœ… æ¨æ–‡å·²æˆåŠŸåˆ é™¤", file=sys.stderr)
            return True
        else:
            print(f"âŒ åˆ é™¤å¤±è´¥", file=sys.stderr)
            print(f"   çŠ¶æ€ç : {response.status_code}", file=sys.stderr)
            print(f"   å“åº”: {response.text}", file=sys.stderr)
            return False

    except Exception as e:
        print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}", file=sys.stderr)
        return False


def start_bitbrowser_app():
    """å¯åŠ¨ BitBrowser åº”ç”¨"""
    try:
        print("... æ­£åœ¨å¯åŠ¨ BitBrowser åº”ç”¨...", file=sys.stderr)
        subprocess.run(["open", "-a", "BitBrowser Global"], check=True)
        for i in range(10):
            time.sleep(1)
            try:
                resp = requests.get(f"{BITBROWSER_API}/", timeout=2)
                if resp.status_code:
                    print("BitBrowser å·²å¯åŠ¨", file=sys.stderr)
                    return True
            except:
                pass
        return True
    except Exception as e:
        print(f"å¯åŠ¨ BitBrowser å¤±è´¥: {e}", file=sys.stderr)
        return False


def open_bitbrowser_window(retry_after_start=True):
    """è‡ªåŠ¨æ‰“å¼€ BitBrowser çª—å£"""
    try:
        resp = requests.post(
            f"{BITBROWSER_API}/browser/list",
            json={"page": 0, "pageSize": 100},
            timeout=5
        )
        data = resp.json()

        if not data.get("success"):
            return False, "æ— æ³•è·å–æµè§ˆå™¨åˆ—è¡¨"

        browser_id = None
        for browser in data.get("data", {}).get("list", []):
            if browser.get("name") == BROWSER_NAME:
                browser_id = browser.get("id")
                break

        if not browser_id:
            return False, f"æœªæ‰¾åˆ°æµè§ˆå™¨é…ç½®: {BROWSER_NAME}"

        print(f"... æ­£åœ¨å¯åŠ¨ BitBrowser çª—å£ '{BROWSER_NAME}'...", file=sys.stderr)
        resp = requests.post(
            f"{BITBROWSER_API}/browser/open",
            json={"id": browser_id},
            timeout=30
        )
        data = resp.json()

        if data.get("success"):
            time.sleep(3)
            return True, "çª—å£å·²å¯åŠ¨"
        else:
            return False, data.get("msg", "æ‰“å¼€å¤±è´¥")

    except requests.exceptions.ConnectionError:
        if retry_after_start:
            if start_bitbrowser_app():
                return open_bitbrowser_window(retry_after_start=False)
        return False, "BitBrowser åº”ç”¨æœªè¿è¡Œ"
    except Exception as e:
        return False, str(e)


def check_prerequisites():
    """æ£€æŸ¥å‰ç½®æ¡ä»¶ï¼šæœåŠ¡å’Œæµè§ˆå™¨çª—å£ï¼ˆä»…æœç´¢åŠŸèƒ½éœ€è¦ï¼‰"""
    try:
        resp = requests.get(HEALTH_URL, timeout=3)
        data = resp.json()

        if not data.get("connected"):
            print("... æ­£åœ¨è¿æ¥ BitBrowser...", file=sys.stderr)
            try:
                warmup_resp = requests.get(WARMUP_URL, timeout=15)
                warmup_data = warmup_resp.json()
                if warmup_data.get("success"):
                    print("è¿æ¥æˆåŠŸ", file=sys.stderr)
                    return True
            except:
                pass

            success, msg = open_bitbrowser_window()
            if not success:
                print(f"é”™è¯¯: {msg}", file=sys.stderr)
                sys.exit(1)

            try:
                warmup_resp = requests.get(WARMUP_URL, timeout=15)
                warmup_data = warmup_resp.json()
                if warmup_data.get("success"):
                    print("è¿æ¥æˆåŠŸ", file=sys.stderr)
                    return True
            except:
                pass

            print("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ BitBrowser çª—å£æ˜¯å¦æ­£å¸¸", file=sys.stderr)
            sys.exit(1)
        return True

    except requests.exceptions.ConnectionError:
        print("Twitter æœç´¢æœåŠ¡æœªå¯åŠ¨", file=sys.stderr)
        print("", file=sys.stderr)
        print("è¯·æ‰‹åŠ¨å¯åŠ¨æœåŠ¡ï¼š", file=sys.stderr)
        print("  cd ~/code/06-production-business-money-live/twitter-scraper-skills/server", file=sys.stderr)
        print("  python3 start.py", file=sys.stderr)
        sys.exit(1)


def format_results(results: list, title: str, time_cost: str):
    """æ ¼å¼åŒ–è¾“å‡ºç»“æœ"""
    count = len(results)
    print(f"\n{title}")
    print(f"ç»“æœ: {count} æ¡ | è€—æ—¶: {time_cost}")
    print("-" * 60)

    if count == 0:
        print("\næœªæ‰¾åˆ°ç»“æœ")
        print("æç¤º: è¯·ç¡®ä¿å·²åœ¨ BitBrowser çª—å£ç™»å½• x.com")
        print()
        return

    for i, item in enumerate(results, 1):
        username = item.get("username", "")
        display_name = item.get("display_name", "")
        content = item.get("content", "")
        url = item.get("url", "")
        time_str = item.get("time", "")
        stats = item.get("stats", {})

        # æ„å»ºäº’åŠ¨æ•°æ®æ˜¾ç¤º
        stats_str = ""
        if stats:
            parts = []
            if stats.get("replies"):
                parts.append(f"å›å¤:{stats['replies']}")
            if stats.get("retweets"):
                parts.append(f"è½¬å‘:{stats['retweets']}")
            if stats.get("likes"):
                parts.append(f"èµ:{stats['likes']}")
            if parts:
                stats_str = " | ".join(parts)

        print(f"\n{i}. @{username}", end="")
        if display_name and display_name != username:
            print(f" ({display_name})", end="")
        print()

        if content:
            content_clean = content.replace('\n', ' ')
            if len(content_clean) > 300:
                print(f"   {content_clean[:300]}...")
            else:
                print(f"   {content_clean}")

        if time_str:
            print(f"   æ—¶é—´: {time_str}")
        if stats_str:
            print(f"   {stats_str}")
        print(f"   é“¾æ¥: {url}")

    print()


def search(keyword: str, limit: int = 5, output_json: bool = False, sort: str = "top"):
    """æ‰§è¡Œæœç´¢"""
    try:
        resp = requests.get(API_URL, params={"q": keyword, "limit": limit, "sort": sort}, timeout=30)
        data = resp.json()

        if not data.get("success"):
            print(f"é”™è¯¯: {data.get('error', 'æœªçŸ¥é”™è¯¯')}", file=sys.stderr)
            sys.exit(1)

        if output_json:
            print(json.dumps(data, ensure_ascii=False, indent=2))
            return

        sort_label = "æœ€æ–°" if sort in ("new", "live") else "çƒ­é—¨"
        format_results(
            data.get("results", []),
            f"Twitter/X æœç´¢: {keyword} ({sort_label})",
            data.get("time", "N/A")
        )

    except requests.exceptions.ConnectionError:
        print("é”™è¯¯: æ— æ³•è¿æ¥åˆ°æœç´¢æœåŠ¡", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"é”™è¯¯: {e}", file=sys.stderr)
        sys.exit(1)


def get_feed(limit: int = 5, output_json: bool = False, feed_type: str = "foryou"):
    """è·å–æ¨èæµ/å…³æ³¨æµ"""
    try:
        resp = requests.get(FEED_URL, params={"limit": limit, "type": feed_type}, timeout=30)
        data = resp.json()

        if not data.get("success"):
            print(f"é”™è¯¯: {data.get('error', 'æœªçŸ¥é”™è¯¯')}", file=sys.stderr)
            sys.exit(1)

        if output_json:
            print(json.dumps(data, ensure_ascii=False, indent=2))
            return

        title = "Twitter/X æ¨èæµ (For You)" if feed_type == "foryou" else "Twitter/X å…³æ³¨æµ (Following)"
        format_results(
            data.get("results", []),
            title,
            data.get("time", "N/A")
        )

    except requests.exceptions.ConnectionError:
        print("é”™è¯¯: æ— æ³•è¿æ¥åˆ°æœç´¢æœåŠ¡", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"é”™è¯¯: {e}", file=sys.stderr)
        sys.exit(1)


def main():
    # å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºå¸®åŠ©
    if len(sys.argv) == 1:
        print(__doc__)
        sys.exit(0)

    # æ£€æŸ¥ç‰¹æ®Šæ ‡å¿—ï¼ˆ--feed, --followingï¼‰
    if '--feed' in sys.argv:
        check_prerequisites()
        limit = 20
        if '-n' in sys.argv:
            idx = sys.argv.index('-n')
            if idx + 1 < len(sys.argv):
                limit = int(sys.argv[idx + 1])
        get_feed(limit, '--json' in sys.argv, "foryou")
        sys.exit(0)

    if '--following' in sys.argv:
        check_prerequisites()
        limit = 20
        if '-n' in sys.argv:
            idx = sys.argv.index('-n')
            if idx + 1 < len(sys.argv):
                limit = int(sys.argv[idx + 1])
        get_feed(limit, '--json' in sys.argv, "following")
        sys.exit(0)

    # è§£æå­å‘½ä»¤
    parser = argparse.ArgumentParser(
        description="Twitter/X å®Œæ•´ç®¡ç† CLI",
        usage="ts <command> [args]"
    )

    subparsers = parser.add_subparsers(dest='command')

    # post å‘½ä»¤
    post_parser = subparsers.add_parser('post', help='å‘å¸ƒæ¨æ–‡')
    post_parser.add_argument('text', nargs='?', help='æ¨æ–‡å†…å®¹')
    post_parser.add_argument('--file', help='ä»æ–‡ä»¶è¯»å–å†…å®¹')
    post_parser.add_argument('--images', nargs='+', help='å›¾ç‰‡è·¯å¾„ï¼ˆæœ€å¤š4å¼ ï¼‰')
    post_parser.add_argument('--json', action='store_true', help='è¾“å‡ºJSONæ ¼å¼')

    # thread å‘½ä»¤
    thread_parser = subparsers.add_parser('thread', help='å‘å¸ƒ Thread')
    thread_parser.add_argument('--file', required=True, help='Thread æ–‡ä»¶è·¯å¾„')
    thread_parser.add_argument('--images', nargs='+', help='å›¾ç‰‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰')
    thread_parser.add_argument('--json', action='store_true', help='è¾“å‡ºJSONæ ¼å¼')

    # reply å‘½ä»¤
    reply_parser = subparsers.add_parser('reply', help='å›å¤æ¨æ–‡')
    reply_parser.add_argument('tweet_id', help='è¦å›å¤çš„æ¨æ–‡ID')
    reply_parser.add_argument('text', help='å›å¤å†…å®¹')
    reply_parser.add_argument('--images', nargs='+', help='å›¾ç‰‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰')
    reply_parser.add_argument('--json', action='store_true', help='è¾“å‡ºJSONæ ¼å¼')

    # delete å‘½ä»¤
    delete_parser = subparsers.add_parser('delete', help='åˆ é™¤æ¨æ–‡')
    delete_parser.add_argument('tweet_id', help='æ¨æ–‡ID')

    # å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å­å‘½ä»¤ï¼Œå½“ä½œæœç´¢
    if sys.argv[1] not in ['post', 'thread', 'reply', 'delete']:
        # æœç´¢æ¨¡å¼
        search_parser = argparse.ArgumentParser()
        search_parser.add_argument('keyword', help='æœç´¢å…³é”®è¯')
        search_parser.add_argument('-n', '--limit', type=int, default=20, help='ç»“æœæ•°é‡')
        search_parser.add_argument('--json', action='store_true', help='JSONæ ¼å¼')
        search_parser.add_argument('-s', '--sort', choices=['top', 'new', 'live'], default='top')

        args = search_parser.parse_args()
        check_prerequisites()
        search(args.keyword, args.limit, args.json, args.sort)
        sys.exit(0)

    args = parser.parse_args()

    if args.command == 'post':
        # å‘æ¨
        if args.file:
            try:
                with open(args.file, 'r', encoding='utf-8') as f:
                    tweet_text = f.read().strip()
            except Exception as e:
                print(f"âŒ è¯»å–æ–‡ä»¶å¤±è´¥: {e}", file=sys.stderr)
                sys.exit(1)
        elif args.text:
            tweet_text = args.text
        else:
            print("âŒ è¯·æä¾›æ¨æ–‡å†…å®¹æˆ–ä½¿ç”¨ --file å‚æ•°", file=sys.stderr)
            sys.exit(1)

        result = post_tweet(tweet_text, image_paths=args.images)

        if args.json:
            print(json.dumps(result, ensure_ascii=False, indent=2))
        else:
            print(result['url'] if result['success'] else '')

        sys.exit(0 if result['success'] else 1)

    elif args.command == 'thread':
        # å‘ Thread
        tweets = parse_thread_file(args.file)

        if len(tweets) == 0:
            print("âŒ Thread æ–‡ä»¶ä¸ºç©º", file=sys.stderr)
            sys.exit(1)

        results = post_thread(tweets, image_paths=args.images)

        if args.json:
            print(json.dumps(results, ensure_ascii=False, indent=2))
        else:
            if results and results[0]['success']:
                print(results[0]['url'])

        sys.exit(0 if all(r['success'] for r in results) else 1)

    elif args.command == 'reply':
        # å›å¤æ¨æ–‡
        result = post_tweet(args.text, image_paths=args.images, reply_to=args.tweet_id)

        if args.json:
            print(json.dumps(result, ensure_ascii=False, indent=2))
        else:
            print(result['url'] if result['success'] else '')

        sys.exit(0 if result['success'] else 1)

    elif args.command == 'delete':
        # åˆ æ¨
        result = delete_tweet(args.tweet_id)
        sys.exit(0 if result else 1)

    else:
        parser.print_help()
        sys.exit(1)


if __name__ == "__main__":
    main()
