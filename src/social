#!/usr/bin/env python3
"""
social - ç¤¾äº¤å¹³å°å†…å®¹å‘å¸ƒç¼–æ’å·¥å…·

ç”¨æ³•:
    social post <å†…å®¹> [é€‰é¡¹]           # å‘å¸ƒåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå¹³å°
    social thread <æ–‡ä»¶> [é€‰é¡¹]         # å‘å¸ƒ Thread
    social config [é€‰é¡¹]                # é…ç½®ç®¡ç†

å‘å¸ƒé€‰é¡¹:
    --all                   å‘å¸ƒåˆ°æ‰€æœ‰å·²é…ç½®å¹³å°
    --platforms PLATFORMS   æŒ‡å®šå¹³å°ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œå¦‚: twitter,weibo
    --file FILE            ä»æ–‡ä»¶è¯»å–å†…å®¹
    --images IMAGES        å›¾ç‰‡è·¯å¾„ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰

é…ç½®é€‰é¡¹:
    social config list              åˆ—å‡ºæ‰€æœ‰å¹³å°
    social config enable PLATFORM   å¯ç”¨å¹³å°
    social config disable PLATFORM  ç¦ç”¨å¹³å°

ç¤ºä¾‹:
    social post "Hello World" --all                    # å‘å¸ƒåˆ°æ‰€æœ‰å¹³å°
    social post "Hello" --platforms twitter            # ä»…å‘å¸ƒåˆ° Twitter
    social post --file post.txt --images a.jpg --all   # å¤šå¹³å°å›¾æ–‡å‘å¸ƒ
    social thread --file thread.txt --platforms twitter # å‘å¸ƒ Thread
    social config list                                 # æŸ¥çœ‹å¹³å°åˆ—è¡¨
"""

import argparse
import json
import os
import subprocess
import sys
from pathlib import Path
from typing import Dict, List, Optional


# å¹³å°æ³¨å†Œè¡¨ï¼ˆå½“å‰ä»… Twitterï¼‰
PLATFORMS = {
    'twitter': {
        'name': 'Twitter/X',
        'cli': 'ts',
        'enabled': True,
        'features': ['post', 'thread', 'reply', 'images']
    }
    # æœªæ¥å¯æ·»åŠ :
    # 'weibo': {...},
    # 'xhs': {...},
}


def get_config_path():
    """è·å–é…ç½®æ–‡ä»¶è·¯å¾„"""
    config_dir = Path.home() / '.claude'
    config_dir.mkdir(exist_ok=True)
    return config_dir / 'social-config.json'


def load_config():
    """åŠ è½½é…ç½®"""
    config_path = get_config_path()
    if config_path.exists():
        with open(config_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {'platforms': PLATFORMS}


def save_config(config):
    """ä¿å­˜é…ç½®"""
    config_path = get_config_path()
    with open(config_path, 'w', encoding='utf-8') as f:
        json.dump(config, f, ensure_ascii=False, indent=2)


def get_enabled_platforms(config):
    """è·å–å·²å¯ç”¨çš„å¹³å°åˆ—è¡¨"""
    return [
        platform_id
        for platform_id, platform_info in config['platforms'].items()
        if platform_info.get('enabled', False)
    ]


def post_to_twitter(content: str, images: Optional[List[str]] = None, json_output: bool = False) -> Dict:
    """
    å‘å¸ƒåˆ° Twitter

    Args:
        content: æ¨æ–‡å†…å®¹
        images: å›¾ç‰‡è·¯å¾„åˆ—è¡¨
        json_output: æ˜¯å¦è¾“å‡ºJSONæ ¼å¼

    Returns:
        dict: {'success': bool, 'tweet_id': str, 'url': str, 'error': str}
    """
    cmd = ['ts', 'post', content, '--json']

    if images:
        cmd.extend(['--images'] + images)

    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=30
        )

        if result.returncode == 0:
            # è§£æ JSON è¾“å‡º
            try:
                output = json.loads(result.stdout)
                return output
            except json.JSONDecodeError:
                return {
                    'success': False,
                    'error': f'JSON è§£æå¤±è´¥: {result.stdout}'
                }
        else:
            return {
                'success': False,
                'error': result.stderr.strip() or result.stdout.strip()
            }

    except subprocess.TimeoutExpired:
        return {
            'success': False,
            'error': 'Twitter å‘å¸ƒè¶…æ—¶ï¼ˆ30ç§’ï¼‰'
        }
    except FileNotFoundError:
        return {
            'success': False,
            'error': 'ts å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯·ç¡®è®¤å·²å®‰è£…'
        }
    except Exception as e:
        return {
            'success': False,
            'error': f'å‘å¸ƒå¼‚å¸¸: {str(e)}'
        }


def post_thread_to_twitter(file_path: str, images: Optional[List[str]] = None, json_output: bool = False) -> Dict:
    """
    å‘å¸ƒ Thread åˆ° Twitter

    Args:
        file_path: Thread æ–‡ä»¶è·¯å¾„
        images: å›¾ç‰‡è·¯å¾„åˆ—è¡¨
        json_output: æ˜¯å¦è¾“å‡ºJSONæ ¼å¼

    Returns:
        dict: {'success': bool, 'results': list, 'error': str}
    """
    cmd = ['ts', 'thread', '--file', file_path, '--json']

    if images:
        cmd.extend(['--images'] + images)

    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=60
        )

        if result.returncode == 0:
            try:
                output = json.loads(result.stdout)
                return {
                    'success': True,
                    'results': output
                }
            except json.JSONDecodeError:
                return {
                    'success': False,
                    'error': f'JSON è§£æå¤±è´¥: {result.stdout}'
                }
        else:
            return {
                'success': False,
                'error': result.stderr.strip() or result.stdout.strip()
            }

    except subprocess.TimeoutExpired:
        return {
            'success': False,
            'error': 'Twitter Thread å‘å¸ƒè¶…æ—¶ï¼ˆ60ç§’ï¼‰'
        }
    except FileNotFoundError:
        return {
            'success': False,
            'error': 'ts å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯·ç¡®è®¤å·²å®‰è£…'
        }
    except Exception as e:
        return {
            'success': False,
            'error': f'å‘å¸ƒå¼‚å¸¸: {str(e)}'
        }


def publish_to_platforms(
    content: str,
    platforms: List[str],
    images: Optional[List[str]] = None,
    is_thread: bool = False,
    json_output: bool = False
) -> Dict[str, Dict]:
    """
    å‘å¸ƒåˆ°å¤šä¸ªå¹³å°

    Args:
        content: å†…å®¹æˆ–æ–‡ä»¶è·¯å¾„
        platforms: å¹³å°åˆ—è¡¨
        images: å›¾ç‰‡åˆ—è¡¨
        is_thread: æ˜¯å¦ä¸º Thread
        json_output: æ˜¯å¦è¾“å‡ºJSON

    Returns:
        dict: {å¹³å°å: å‘å¸ƒç»“æœ}
    """
    results = {}

    for platform_id in platforms:
        print(f"\nğŸ“¤ æ­£åœ¨å‘å¸ƒåˆ° {PLATFORMS[platform_id]['name']}...", file=sys.stderr)

        if platform_id == 'twitter':
            if is_thread:
                result = post_thread_to_twitter(content, images, json_output)
            else:
                result = post_to_twitter(content, images, json_output)
        else:
            result = {
                'success': False,
                'error': f'å¹³å° {platform_id} å°šæœªå®ç°'
            }

        results[platform_id] = result

        # è¾“å‡ºç»“æœ
        if result['success']:
            if is_thread:
                first_url = result['results'][0].get('url', '')
                print(f"   âœ… æˆåŠŸ: {first_url}", file=sys.stderr)
            else:
                print(f"   âœ… æˆåŠŸ: {result.get('url', '')}", file=sys.stderr)
        else:
            print(f"   âŒ å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}", file=sys.stderr)

    return results


def config_list(config):
    """åˆ—å‡ºæ‰€æœ‰å¹³å°é…ç½®"""
    print("\nğŸ“‹ å¹³å°åˆ—è¡¨:\n")
    for platform_id, platform_info in config['platforms'].items():
        status = "âœ… å·²å¯ç”¨" if platform_info.get('enabled') else "âŒ å·²ç¦ç”¨"
        features = ", ".join(platform_info.get('features', []))
        print(f"  {platform_id}")
        print(f"    åç§°: {platform_info['name']}")
        print(f"    çŠ¶æ€: {status}")
        print(f"    CLI: {platform_info.get('cli', 'N/A')}")
        print(f"    åŠŸèƒ½: {features}")
        print()


def config_enable(config, platform_id):
    """å¯ç”¨å¹³å°"""
    if platform_id not in config['platforms']:
        print(f"âŒ æœªçŸ¥å¹³å°: {platform_id}", file=sys.stderr)
        print(f"å¯ç”¨å¹³å°: {', '.join(config['platforms'].keys())}", file=sys.stderr)
        sys.exit(1)

    config['platforms'][platform_id]['enabled'] = True
    save_config(config)
    print(f"âœ… å·²å¯ç”¨å¹³å°: {platform_id}")


def config_disable(config, platform_id):
    """ç¦ç”¨å¹³å°"""
    if platform_id not in config['platforms']:
        print(f"âŒ æœªçŸ¥å¹³å°: {platform_id}", file=sys.stderr)
        sys.exit(1)

    config['platforms'][platform_id]['enabled'] = False
    save_config(config)
    print(f"âœ… å·²ç¦ç”¨å¹³å°: {platform_id}")


def main():
    if len(sys.argv) == 1:
        print(__doc__)
        sys.exit(0)

    parser = argparse.ArgumentParser(
        description='ç¤¾äº¤å¹³å°å†…å®¹å‘å¸ƒç¼–æ’å·¥å…·',
        usage='social <command> [args]'
    )

    subparsers = parser.add_subparsers(dest='command', help='å­å‘½ä»¤')

    # post å‘½ä»¤
    post_parser = subparsers.add_parser('post', help='å‘å¸ƒå†…å®¹')
    post_parser.add_argument('text', nargs='?', help='å†…å®¹æ–‡æœ¬')
    post_parser.add_argument('--file', help='ä»æ–‡ä»¶è¯»å–å†…å®¹')
    post_parser.add_argument('--all', action='store_true', help='å‘å¸ƒåˆ°æ‰€æœ‰å¹³å°')
    post_parser.add_argument('--platforms', help='æŒ‡å®šå¹³å°ï¼ˆé€—å·åˆ†éš”ï¼‰')
    post_parser.add_argument('--images', nargs='+', help='å›¾ç‰‡è·¯å¾„')
    post_parser.add_argument('--json', action='store_true', help='è¾“å‡ºJSONæ ¼å¼')

    # thread å‘½ä»¤
    thread_parser = subparsers.add_parser('thread', help='å‘å¸ƒ Thread')
    thread_parser.add_argument('--file', required=True, help='Thread æ–‡ä»¶è·¯å¾„')
    thread_parser.add_argument('--all', action='store_true', help='å‘å¸ƒåˆ°æ‰€æœ‰å¹³å°')
    thread_parser.add_argument('--platforms', help='æŒ‡å®šå¹³å°ï¼ˆé€—å·åˆ†éš”ï¼‰')
    thread_parser.add_argument('--images', nargs='+', help='å›¾ç‰‡è·¯å¾„')
    thread_parser.add_argument('--json', action='store_true', help='è¾“å‡ºJSONæ ¼å¼')

    # config å‘½ä»¤
    config_parser = subparsers.add_parser('config', help='é…ç½®ç®¡ç†')
    config_subparsers = config_parser.add_subparsers(dest='config_command')

    config_subparsers.add_parser('list', help='åˆ—å‡ºæ‰€æœ‰å¹³å°')

    enable_parser = config_subparsers.add_parser('enable', help='å¯ç”¨å¹³å°')
    enable_parser.add_argument('platform', help='å¹³å°ID')

    disable_parser = config_subparsers.add_parser('disable', help='ç¦ç”¨å¹³å°')
    disable_parser.add_argument('platform', help='å¹³å°ID')

    args = parser.parse_args()

    # åŠ è½½é…ç½®
    config = load_config()

    if args.command == 'config':
        if args.config_command == 'list':
            config_list(config)
        elif args.config_command == 'enable':
            config_enable(config, args.platform)
        elif args.config_command == 'disable':
            config_disable(config, args.platform)
        else:
            config_parser.print_help()
        sys.exit(0)

    elif args.command == 'post':
        # ç¡®å®šå†…å®¹
        if args.file:
            with open(args.file, 'r', encoding='utf-8') as f:
                content = f.read().strip()
        elif args.text:
            content = args.text
        else:
            print("âŒ å¿…é¡»æä¾› --file æˆ–æ–‡æœ¬å†…å®¹", file=sys.stderr)
            sys.exit(1)

        # ç¡®å®šå¹³å°
        if args.all:
            platforms = get_enabled_platforms(config)
        elif args.platforms:
            platforms = [p.strip() for p in args.platforms.split(',')]
        else:
            print("âŒ å¿…é¡»æŒ‡å®š --all æˆ– --platforms", file=sys.stderr)
            sys.exit(1)

        if not platforms:
            print("âŒ æ²¡æœ‰å¯ç”¨çš„å¹³å°ï¼Œè¯·å…ˆå¯ç”¨å¹³å°", file=sys.stderr)
            sys.exit(1)

        # å‘å¸ƒ
        results = publish_to_platforms(
            content,
            platforms,
            images=args.images,
            is_thread=False,
            json_output=args.json
        )

        # è¾“å‡º JSON
        if args.json:
            print(json.dumps(results, ensure_ascii=False, indent=2))

        # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥
        failures = [p for p, r in results.items() if not r['success']]
        if failures:
            print(f"\nâš ï¸  éƒ¨åˆ†å¹³å°å‘å¸ƒå¤±è´¥: {', '.join(failures)}", file=sys.stderr)
            sys.exit(1)
        else:
            print(f"\nâœ… æ‰€æœ‰å¹³å°å‘å¸ƒæˆåŠŸ", file=sys.stderr)

    elif args.command == 'thread':
        # ç¡®å®šå¹³å°
        if args.all:
            platforms = get_enabled_platforms(config)
        elif args.platforms:
            platforms = [p.strip() for p in args.platforms.split(',')]
        else:
            print("âŒ å¿…é¡»æŒ‡å®š --all æˆ– --platforms", file=sys.stderr)
            sys.exit(1)

        if not platforms:
            print("âŒ æ²¡æœ‰å¯ç”¨çš„å¹³å°ï¼Œè¯·å…ˆå¯ç”¨å¹³å°", file=sys.stderr)
            sys.exit(1)

        # å‘å¸ƒ Thread
        results = publish_to_platforms(
            args.file,
            platforms,
            images=args.images,
            is_thread=True,
            json_output=args.json
        )

        # è¾“å‡º JSON
        if args.json:
            print(json.dumps(results, ensure_ascii=False, indent=2))

        # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥
        failures = [p for p, r in results.items() if not r['success']]
        if failures:
            print(f"\nâš ï¸  éƒ¨åˆ†å¹³å°å‘å¸ƒå¤±è´¥: {', '.join(failures)}", file=sys.stderr)
            sys.exit(1)
        else:
            print(f"\nâœ… æ‰€æœ‰å¹³å°å‘å¸ƒæˆåŠŸ", file=sys.stderr)

    else:
        parser.print_help()


if __name__ == '__main__':
    main()
